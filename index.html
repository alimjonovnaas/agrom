<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>User Info</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {margin:0; font-family:system-ui,sans-serif; background:#0e1621; color:white; padding:20px; min-height:100vh;}
    .card {background:rgba(255,255,255,0.1); backdrop-filter:blur(12px); border-radius:20px; padding:24px; max-width:420px; margin:40px auto; text-align:center;}
    .avatar {width:120px; height:120px; border-radius:50%; border:5px solid #229ed9; margin-bottom:16px;}
    .name {font-size:26px; font-weight:800; margin:12px 0 6px;}
    .username {font-size:19px; color:#8aadf4; margin-bottom:20px;}
    .info {background:rgba(255,255,255,0.08); padding:16px; border-radius:14px; text-align:left; line-height:1.9; font-size:15px;}
    .btn {margin-top:24px; padding:14px 28px; border:none; border-radius:14px; font-weight:700; cursor:pointer; font-size:16px;}
    .send {background:#229ed9; color:white;}
    .close {background:#4b5563; color:white; margin-left:12px;}
  </style>
</head>
<body>

  <div class="card">
    <img id="avatar" class="avatar" src="" alt="Avatar">
    <div id="name" class="name">Yuklanmoqda...</div>
    <div id="username" class="username">@username</div>

    <div id="info" class="info">Maʼlumotlar yuklanmoqda...</div>

    <div>
      <button id="send" class="btn send">Botga maʼlumot yuborish</button>
      <button id="close" class="btn close">Yopish</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;

    // Telegram tayyor
    tg.ready();
    tg.expand();

    function showUserInfo() {
      const user = tg.initDataUnsafe?.user;

      if (!user || !user.id) {
        document.getElementById('info').innerHTML = '<span style="color:#ff6b6b">Foydalanuvchi maʼlumotlari topilmadi.<br>Bot orqali qayta kirib koʻring!</span>';
        return;
      }

      // Ism-familiya
      const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ') || 'Foydalanuvchi';
      document.getElementById('name').textContent = fullName;

      // Username
      document.getElementById('username').textContent = user.username ? `@${user.username}` : '(username yoʻq)';

      // Avatar
      const avatar = document.getElementById('avatar');
      if (user.photo_url) {
        avatar.src = user.photo_url + '?size=512'; // eng katta sifat
      } else {
        avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=229ed9&color=fff&size=512&bold=true&rounded=true`;
      }

      // Barcha initData maʼlumotlari
      document.getElementById('info').innerHTML = `
        <b>User ID:</b> ${user.id}<br>
        <b>Ism:</b> ${user.first_name || ''} ${user.last_name || ''}<br>
        <b>Username:</b> ${user.username ? '@'+user.username : 'yoʻq'}<br>
        <b>Tili:</b> ${user.language_code || 'nomaʼlum'}<br>
        <b>Premium:</b> ${user.is_premium ? 'Ha' : 'Yoʻq'}<br>
        <b>Botga yozish ruxsati:</b> ${user.allows_write_to_pm ? 'Ha' : 'Yoʻq'}<br>
        <b>Kirish vaqti:</b> ${new Date().toLocaleString('uz-UZ')}
      `;
    }

    // 3 ta usul bilan 100% chiqishini taʼminlaymiz
    showUserInfo();                                   // 1-darhol
    tg.onEvent('viewportChanged', showUserInfo);      // 2-event
    tg.onEvent('themeChanged', showUserInfo);         // 3-event
    setTimeout(showUserInfo, 700);                    // 4-eng ishonchli

    // Botga faqat initData orqali maʼlumot yuborish
    document.getElementById('send').onclick = () => {
      tg.sendData(JSON.stringify({
        from: "pure_frontend_miniapp",
        user: tg.initDataUnsafe.user,
        raw_init_data: tg.initData
      }));
      tg.showAlert('Maʼlumot botga yuborildi!');
    };

    document.getElementById('close').onclick = () => tg.close();
  </script>
</body>
</html>