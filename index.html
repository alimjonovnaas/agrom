<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mening Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {font-family: system-ui, sans-serif; background: #f0f2f5; padding: 20px; margin:0}
    .card {background: white; border-radius: 20px; padding: 24px; max-width: 420px; margin: 20px auto; box-shadow: 0 8px 32px rgba(0,0,0,0.12);}
    .avatar {width: 100px; height: 100px; border-radius: 50%; border: 5px solid #fff; box-shadow: 0 6px 20px rgba(0,0,0,0.15);}
    .name {font-size: 24px; font-weight: 700; margin: 16px 0 6px; text-align:center;}
    .username {font-size: 18px; color: #777; text-align:center;}
    .info {margin-top: 20px; background: #f8f9fa; padding: 16px; border-radius: 12px; line-height: 1.8; font-size: 15px;}
    button {margin-top: 20px; padding: 14px 24px; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; font-size: 16px;}
    .btn1 {background: #229ed9; color: white;}
    .btn2 {background: #e4e6eb; color: #1c1e21; margin-left: 12px;}
    .center {text-align: center;}
  </style>
</head>
<body>

  <div class="card">
    <div class="center">
      <img id="avatar" class="avatar" src="" alt="Avatar">
      <div id="name" class="name">Yuklanmoqda...</div>
      <div id="username" class="username">@username</div>
    </div>

    <div id="info" class="info">Maʼlumotlar yuklanmoqda...</div>

    <div class="center">
      <button class="btn1" id="send">Botga salom yuborish</button>
      <button class="btn2" id="close">Yopish</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;

    // Telegram tayyorligini bildirish
    tg.ready();
    tg.expand();

    // Foydalanuvchi ma'lumotlarini ko'rsatish funksiyasi
    function renderUser() {
      const user = tg.initDataUnsafe?.user;

      if (!user || !user.id) {
        document.getElementById('info').innerHTML = '<b style="color:red">Xatolik:</b> Foydalanuvchi maʼlumotlari topilmadi.<br>Bot orqali qayta kirib koʻring.';
        return;
      }

      // Ism-familiya
      const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ') || 'Foydalanuvchi';
      document.getElementById('name').textContent = fullName;

      // Username
      document.getElementById('username').textContent = user.username ? `@${user.username}` : '(username yoʻq)';

      // Avatar
      const avatarEl = document.getElementById('avatar');
      if (user.photo_url) {
        avatarEl.src = user.photo_url;
      } else {
        // Telegram rangiga mos avatar generatsiya
        avatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=229ed9&color=fff&size=256&bold=true&rounded=true`;
      }

      // Qoʻshimcha maʼlumotlar (faqat initData dan!)
      document.getElementById('info').innerHTML = `
        <b>User ID:</b> ${user.id}<br>
        <b>Tili:</b> ${user.language_code || 'nomaʼlum'}<br>
        <b>Premium:</b> ${user.is_premium ? 'Ha' : 'Yoʻq'}<br>
        <b>Bot ruxsati:</b> ${user.allows_write_to_pm ? 'Ha' : 'Yoʻq'}<br>
        <b>InitData (xom):</b> <small style="word-break:break-all; color:#0066cc;">${tg.initData}</small>
      `;
    }

    // 1. Darhol koʻrsatish
    renderUser();

    // 2. Agar kechiksa — eventlarni tinglash (2025-yilda majburiy!)
    tg.onEvent('viewportChanged', renderUser);
    tg.onEvent('themeChanged', renderUser);

    // 3. Eng ishonchli — 800 ms kutib qayta urinish
    setTimeout(renderUser, 800);

    // Botga ma'lumot yuborish (faqat initData orqali)
    document.getElementById('send').onclick = () => {
      const payload = {
        action: "user_hello",
        from_miniapp: true,
        user: tg.initDataUnsafe.user,
        initData: tg.initData  // bot bu orqali 100% tekshiradi
      };
      tg.sendData(JSON.stringify(payload));
      tg.showAlert('Maʼlumot botga muvaffaqiyatli yuborildi!');
    };

    document.getElementById('close').onclick = () => tg.close();
  </script>
</body>
</html>